---
title: "r-project"
author: "Riley Maher, Griffin Rubin, Katie Summers, Natalie Vadasz"
date: "Dec 8, 2020"
output: 
  html_document: 
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Group Project

## Import Packages

```{r}
library("ggplot2")
library('dplyr')
library('tidyverse')
library('geosphere')
library("ggmap")
```

## Importing Data

```{r}
# Reading in the sample CSV of rider data we made
rider_2019_sample <- read.csv('sample.csv', stringsAsFactors = TRUE)
head(rider_2019_sample)

# Reading in the weather data set
weather_data <- read.csv('NYCWeather2019.csv', stringsAsFactors = TRUE)
head(weather_data)
```

## Initial Data Summary

```{r}
# Initial summary of rider data set
str(rider_2019_sample)
summary(rider_2019_sample)
```

```{r}
# Initial summart of weather data set
str(weather_data)
summary(rider_2019_sample)
```


## Initial Data Analysis

### Rider Age

```{r}
rider_2019_sample$age <- 2019 - as.numeric(as.character(rider_2019_sample$birth.year))
rider_2019_sample <- filter(rider_2019_sample, age <= 80)
```

### Gender Split in Riders

```{r}
# Reclassifying the genders
# 0=unknown, 1=male, 2=female
rider_2019_sample$gender <- ifelse(rider_2019_sample$gender == 0, "Unkown",
                                  ifelse(rider_2019_sample$gender == 1, "Male", "Female"))

# Seeing the split of genders who rented bikes
rider_2019_sample %>%
  ggplot(aes(x=gender)) +
  geom_bar()
```

### Subscriber vs Customer for Riders

```{r}
# Seeing the split of user type who rented bikes
rider_2019_sample %>%
  ggplot(aes(x=usertype)) +
  geom_bar()
```

### Trip Duration

```{r}
# Range of all bike rides
rider_2019_sample <- filter(rider_2019_sample, tripduration <= 3000)
duration_range <- range(rider_2019_sample$tripduration, na.rm=TRUE)
duration_range

# Average length of a bike ride
duration_mean <- mean(rider_2019_sample$tripduration, na.rm=TRUE)
duration_mean

# Standard deviation of bike rides
duration_sd <- sd(rider_2019_sample$tripduration, na.rm=TRUE)
duration_sd
```

### Adjusting Dates in Data Sets

```{r}
# Creating columns of just month, day, and year
weather_data$DATE <- as.Date(weather_data$DATE, format = "%m/%d/%Y")
weather_data$Month <- format(weather_data$DATE, "%m")
weather_data$Day <- format(weather_data$DATE, "%d")
weather_data$Year <- format(weather_data$DATE, "%Y")
```

```{r}
# Creating columns of just month, day, and year
rider_2019_sample$DATE <- as.Date(rider_2019_sample$starttime, format = "%Y-%m-%d")
rider_2019_sample$Month <- format(rider_2019_sample$DATE, "%m")
rider_2019_sample$Day <- format(rider_2019_sample$DATE, "%d")
rider_2019_sample$Year <- format(rider_2019_sample$DATE, "%Y")
```

### Types of Weather per Month

```{r}
# Average precipitation per month
weather_data %>% 
  summarise(average_precip = tapply(PRCP, Month, mean, na.rm=TRUE))
```

```{r}
# Average snow per month
weather_data %>% 
  summarise(avg_snow = tapply(SNOW, Month, mean, na.rm=TRUE))
```

```{r}
# Average wind speed per month
weather_data %>%
  summarise(average_wind_speed = tapply(AWND, Month, mean, na.rm=TRUE))
```

## Exploratory Data Analysis - Weather Effects

```{r}
# Combining data frames to compare data
edited_weather <- select(weather_data, PRCP, SNOW, AWND, DATE)
edited_rider <- select(rider_2019_sample, age, tripduration, DATE)

total_data = merge(edited_weather, edited_rider, by.x="DATE", by.y="DATE", all.x=TRUE)
head(total_data)
```

### Average Precipitation by Age

```{r}
# Mean PRCP by Age of Rider
total_data %>% 
  group_by(age) %>%
  summarise(mean_PRCP_by_age = mean(PRCP)) %>%
  ggplot(aes(x = age, y = mean_PRCP_by_age)) + geom_line() + geom_smooth() 
```

### Average Wind by Age

```{r}
# Mean Wind by Age of Rider
total_data %>% 
  group_by(age) %>%
  summarise(mean_AWND_by_age = mean(AWND,na.rm = TRUE)) %>%
  ggplot(aes(x = age, y = mean_AWND_by_age)) + geom_line() + geom_smooth() 
```

## Precipitation Effects on Trip Duration

```{r}
# Average ride time when it's raining
total_data %>%
  filter(PRCP > 0) %>%
  summarise(prcp_duration_mean = mean(tripduration))

total_data %>% 
  filter(PRCP > 0) %>%
  ggplot(aes(x = tripduration)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") 

total_data %>%
  filter(PRCP > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_density(aes(fill=factor(PRCP)), alpha=0.8)

total_data %>%
  filter(PRCP > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_histogram()
```

### Snow Effects on Trip Duration

```{r}
# Average ride time when it's snowing
total_data %>%
  filter(SNOW > 0) %>%
  summarise(snow_duration_mean = mean(tripduration))

total_data %>% 
  filter(SNOW > 0) %>%
  ggplot(aes(x = tripduration)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") 

total_data %>%
  filter(SNOW > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_density(aes(fill=factor(SNOW)), alpha=0.8)

total_data %>%
  filter(SNOW > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_histogram()
```

### Wind Effects on Trip Duration

```{r}
# Average ride time when it's windy
total_data %>%
  filter(AWND > 0) %>%
  summarise(wind_duration_mean = mean(tripduration))

total_data %>% 
  filter(AWND > 0) %>%
  ggplot(aes(x = tripduration)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") 

total_data %>%
  filter(AWND > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_density(aes(fill=factor(AWND)), alpha=0.8)

total_data %>%
  filter(AWND > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_histogram()
```

## Exploratory Data Analysis - Ride History

### Distance Between Stations

```{r}
# Distance between start and end station in Meters
rider_2019_sample <- mutate(rider_2019_sample, 
                            distance = distHaversine(cbind(rider_2019_sample$start.station.longitude,
                                                           rider_2019_sample$start.station.latitude),
                                                     cbind(rider_2019_sample$end.station.longitude,
                                                           rider_2019_sample$end.station.latitude)))

head(rider_2019_sample)
```

### Speed of Rider Demographics

```{r}
# Speed of the rider
rider_2019_sample$speed <- rider_2019_sample$distance/rider_2019_sample$tripduration

# Average speed of all riders
rider_2019_sample %>%
  summarise(average_speed = mean(speed))

# Average speed of young riders
rider_2019_sample %>%
  filter(age <= 45) %>%
  summarise(young_average = mean(speed))

# Average speed of old riders
rider_2019_sample %>%
  filter(age >= 65) %>%
  summarise(old_average = mean(speed))

# Average speed of female riders
rider_2019_sample %>%
  filter(gender == "Female") %>%
  summarise(female_average = mean(speed))

# Average speed of male riders
rider_2019_sample %>%
  filter(gender == "Male") %>%
  summarise(male_average = mean(speed))

# Average speed of subscribers
rider_2019_sample %>%
  filter(usertype == "Customer") %>%
  summarise(customer_average = mean(speed))

# Average speed of customers
rider_2019_sample %>%
  filter(usertype == "Subscriber") %>%
  summarise(subscriber_average = mean(speed))
```

```{r}
# Scatter Plot of speed by age
rider_2019_sample %>%
  ggplot(aes(x = age, y = speed)) +
  geom_point(alpha = .25, color = 'blue', size = 1) +
  geom_point(shape = 1, size = 1, colour = "black") +
  labs(title="Average Speed of Riders by Age", x="Speed", y="Age")
```

```{r}
# Boxplot of speed by gender
rider_2019_sample %>%
  ggplot(aes(x = gender, y = speed)) +
  geom_boxplot() +
  labs(title="Speed of Riders by Gender", x="Gender", y="Speed")
```

```{r}
# Boxplot of speed by customer type
rider_2019_sample %>%
  ggplot(aes(x = usertype, y = speed)) +
  geom_boxplot() +
  labs(title="Speed of Riders by Customer Type", x="Customer Type", y="Speed")
```

### Start Locations

```{r}
top_height <- max(rider_2019_sample$start.station.latitude) - min(rider_2019_sample$start.station.latitude)
top_width <- max(rider_2019_sample$start.station.longitude) - min(rider_2019_sample$start.station.longitude)
top_borders <- c(bottom  = min(rider_2019_sample$start.station.latitude)  - 0.1 * top_height,
                 top     = max(rider_2019_sample$start.station.latitude)  + 0.1 * top_height,
                 left    = min(rider_2019_sample$start.station.longitude) - 0.2 * top_width,
                 right   = max(rider_2019_sample$start.station.longitude) + 0.2 * top_width)

start <- get_stamenmap(top_borders, zoom = 12, maptype = "toner-lite")
start_map <- ggmap(start, extent = "device", legend = "topright")

start_map + stat_density2d(
aes(x = start.station.longitude, y = start.station.latitude, fill = ..level.., alpha = ..level..),
size = 1, bins = 5, data = rider_2019_sample,
geom = "polygon"
)

```


#### Start Location Preferences - by Day of Week
```{r}
# convert dates to weekdays
rider_2019_sample$day_of_week = weekdays(rider_2019_sample$DATE)

start_map +
stat_density2d(
aes(x = start.station.longitude, y = start.station.latitude, fill = ..level.., alpha = ..level..),
bins = 5, geom = "polygon",
data = rider_2019_sample) +
scale_fill_gradient(low = "black", high = "red") +
facet_wrap(~ day_of_week)

```

#### Start Location Preferences - by Gender

```{r}
start_map +
stat_density2d(
aes(x = start.station.longitude, y = start.station.latitude, fill = ..level.., alpha = ..level..),
bins = 5, geom = "polygon",
data = rider_2019_sample) +
scale_fill_gradient(low = "black", high = "red") +
facet_wrap(~ gender)

```

#### Start Location Preferences - by Customer Type
```{r}
start_map +
stat_density2d(
aes(x = start.station.longitude, y = start.station.latitude, fill = ..level.., alpha = ..level..),
bins = 5, geom = "polygon",
data = rider_2019_sample) +
scale_fill_gradient(low = "black", high = "red") +
facet_wrap(~ usertype)

```


#### Start Location Preferences - by Trip Duration
```{r}
ggmap(start) +
    geom_point(data = rider_2019_sample, mapping = aes(x = start.station.longitude, y = start.station.latitude,
                                        col = tripduration)) +
    scale_color_gradient(low = "yellow", high = "red")
```



### End Location Preferences
```{r}
end <- get_stamenmap(top_borders, zoom = 12, maptype = "toner-lite")
end_map <- ggmap(end, extent = "device", legend = "topright")

end_map + stat_density2d(
aes(x = end.station.longitude, y = end.station.latitude, fill = ..level.., alpha = ..level..),
size = 1, bins = 5, data = rider_2019_sample,
geom = "polygon"
)
```

#### End Location Preferences - by Day of Week

```{r}
end_map +
stat_density2d(
aes(x = end.station.longitude, y = end.station.latitude, fill = ..level.., alpha = ..level..),
bins = 5, geom = "polygon",
data = rider_2019_sample) +
scale_fill_gradient(low = "black", high = "red") +
facet_wrap(~ day_of_week)

```

#### End Location Preferences - by Gender

```{r}
end_map +
stat_density2d(
aes(x = end.station.longitude, y = end.station.latitude, fill = ..level.., alpha = ..level..),
bins = 5, geom = "polygon",
data = rider_2019_sample) +
scale_fill_gradient(low = "black", high = "red") +
facet_wrap(~ gender)

```

#### End Location Preferences - by User Type

```{r}
end_map +
stat_density2d(
aes(x = end.station.longitude, y = end.station.latitude, fill = ..level.., alpha = ..level..),
bins = 5, geom = "polygon",
data = rider_2019_sample) +
scale_fill_gradient(low = "black", high = "red") +
facet_wrap(~ usertype)

```

