---
title: "r-project"
author: "Riley Maher, Griffin Rubin, Katie Summers, Natalie Vadasz"
date: "Dec 8, 2020"
output: 
  html_document: 
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Group Project

## Import Packages

```{r}
library("ggplot2")
library('dplyr')
library('tidyverse')
library('geosphere')
```

## Importing Data

```{r}
# Reading in the sample CSV of rider data we made
rider_2019_sample <- read.csv('sample.csv', stringsAsFactors = TRUE)
head(rider_2019_sample)

# Reading in the weather data set
weather_data <- read.csv('NYCWeather2019.csv', stringsAsFactors = TRUE)
head(weather_data)
```

## Initial Data Summary

```{r}
# Initial summary of rider data set
str(rider_2019_sample)
summary(rider_2019_sample)
```

```{r}
# Initial summart of weather data set
str(weather_data)
summary(rider_2019_sample)
```

### Adjusting Dates in Data Sets

```{r}
# Creating columns of just month, day, and year
weather_data$DATE <- as.Date(weather_data$DATE, format = "%m/%d/%Y")
weather_data$Month <- format(weather_data$DATE, "%m")
weather_data$Day <- format(weather_data$DATE, "%d")
weather_data$Year <- format(weather_data$DATE, "%Y")
```

```{r}
# Creating columns of just month, day, and year
rider_2019_sample$DATE <- as.Date(rider_2019_sample$starttime, format = "%Y-%m-%d")
rider_2019_sample$Month <- format(rider_2019_sample$DATE, "%m")
rider_2019_sample$Day <- format(rider_2019_sample$DATE, "%d")
rider_2019_sample$Year <- format(rider_2019_sample$DATE, "%Y")
```

### Rider Age

```{r}
rider_2019_sample$age <- 2019 - as.numeric(as.character(rider_2019_sample$birth.year))
rider_2019_sample <- filter(rider_2019_sample, age <= 80)
```

### Combining Data Sets

```{r}
# Combining data frames to compare data
edited_weather <- select(weather_data,
                         PRCP,
                         SNOW,
                         AWND,
                         DATE)
edited_rider <- select(rider_2019_sample, 
                       age,
                       gender,
                       usertype,
                       tripduration,
                       start.station.latitude,
                       start.station.longitude,
                       end.station.latitude,
                       end.station.longitude,
                       DATE,
                       Day,
                       Month,
                       Year)

total_data = merge(edited_weather, edited_rider, by.x="DATE", by.y="DATE", all.x=TRUE)
head(total_data)
```

## Initial Data Analysis

### Gender Split in Riders

```{r}
# Reclassifying the genders
# 0=unknown, 1=male, 2=female
total_data$gender <- ifelse(total_data$gender == 0, "Unknown",
                                  ifelse(total_data$gender == 1, "Male", "Female"))

# Seeing the split of genders who rented bikes
total_data %>%
  ggplot(aes(x=gender)) +
  geom_bar()
```

### Subscriber vs Customer for Riders

```{r}
# Seeing the split of user type who rented bikes
total_data %>%
  ggplot(aes(x=usertype)) +
  geom_bar()
```

### Trip Duration

```{r}
# Range of all bike rides
total_data <- filter(total_data, tripduration <= 3600)
duration_range <- range(total_data$tripduration, na.rm=TRUE)
duration_range

# Average length of a bike ride
duration_mean <- mean(total_data$tripduration, na.rm=TRUE)
duration_mean

# Standard deviation of bike rides
duration_sd <- sd(total_data$tripduration, na.rm=TRUE)
duration_sd
```
### Trip Duration with Rain

```{r}
# Range of all bike rides affected by rain
total_data_rain <- filter(total_data, SNOW == 0, PRCP > 0)
duration_range_rain <- range(total_data_rain$tripduration, na.rm=TRUE)
duration_range_rain

# Average length of a bike ride affected by rain
duration_mean_rain <- mean(total_data_rain$tripduration, na.rm=TRUE)
duration_mean_rain

# Standard deviation of bike rides affected by rain
duration_sd_rain <- sd(total_data_rain$tripduration, na.rm=TRUE)
duration_sd_rain
```

### Trip Duration with Snow

```{r}
# Range of all bike rides affected by snow
total_data_snow <- filter(total_data, SNOW > 0)
duration_range_snow <- range(total_data_snow$tripduration, na.rm=TRUE)
duration_range_snow

# Average length of a bike ride affected by snow
duration_mean_snow <- mean(total_data_snow$tripduration, na.rm=TRUE)
duration_mean_snow

# Standard deviation of bike rides affected by snow
duration_sd_snow <- sd(total_data_snow$tripduration, na.rm=TRUE)
duration_sd_snow
```

### Trip Duration with Wind

```{r}
# Range of all bike rides affected by wind
total_data_wind <- filter(total_data, SNOW == 0, PRCP == 0, AWND > 0)
duration_range_wind <- range(total_data_wind$tripduration, na.rm=TRUE)
duration_range_wind

# Average length of a bike ride affected by wind
duration_mean_wind <- mean(total_data_wind$tripduration, na.rm=TRUE)
duration_mean_wind

# Standard deviation of bike rides affected by wind
duration_sd_wind <- sd(total_data_wind$tripduration, na.rm=TRUE)
duration_sd_wind
```

### Types of Weather per Month

```{r}
# Average rain per month
total_data %>%
  filter(SNOW == 0) %>%
  summarise(average_rain = tapply(PRCP, Month, mean, na.rm=TRUE))
```

```{r}
# Average snow per month
total_data %>% 
  summarise(avg_snow = tapply(SNOW, Month, mean, na.rm=TRUE))
```

```{r}
# Average wind speed per month
total_data %>%
  summarise(average_wind_speed = tapply(AWND, Month, mean, na.rm=TRUE))
```

## Exploratory Data Analysis - Weather Effects

### Average Precipitation by Age

```{r}
# Mean PRCP by Age of Rider
total_data %>% 
  group_by(age) %>%
  summarise(mean_PRCP_by_age = mean(PRCP)) %>%
  ggplot(aes(x = age, y = mean_PRCP_by_age)) + geom_line() + geom_smooth() 
```

### Average Wind by Age

```{r}
# Mean Wind by Age of Rider
total_data %>% 
  group_by(age) %>%
  summarise(mean_AWND_by_age = mean(AWND,na.rm = TRUE)) %>%
  ggplot(aes(x = age, y = mean_AWND_by_age)) + geom_line() + geom_smooth() 
```

## Rain Effects on Trip Duration

```{r}
# Average ride time when it's raining
total_data %>%
  filter(PRCP > 0, SNOW == 0) %>%
  summarise(prcp_duration_mean = mean(tripduration))

total_data %>% 
  filter(PRCP > 0, SNOW == 0) %>%
  ggplot(aes(x = tripduration)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") 

total_data %>%
  filter(PRCP > 0, SNOW == 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_density(aes(fill=factor(PRCP)), alpha=0.8)

total_data %>%
  filter(PRCP > 0, SNOW == 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_histogram()
```

### Snow Effects on Trip Duration

```{r}
# Average ride time when it's snowing
total_data %>%
  filter(SNOW > 0) %>%
  summarise(snow_duration_mean = mean(tripduration))

total_data %>% 
  filter(SNOW > 0) %>%
  ggplot(aes(x = tripduration)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") 

total_data %>%
  filter(SNOW > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_density(aes(fill=factor(SNOW)), alpha=0.8)

total_data %>%
  filter(SNOW > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_histogram()
```

### Wind Effects on Trip Duration

```{r}
# Average ride time when it's windy
total_data %>%
  filter(AWND > 0) %>%
  summarise(wind_duration_mean = mean(tripduration))

total_data %>% 
  filter(AWND > 0) %>%
  ggplot(aes(x = tripduration)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") 

total_data %>%
  filter(AWND > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_density(aes(fill=factor(AWND)), alpha=0.8)

total_data %>%
  filter(AWND > 0) %>%
  ggplot(aes(x = tripduration)) +
  geom_histogram()
```

### Weather Effects on Number of Rides over Average Ride Time

```{r}
# Number of rides over average time sin weather effects
ride_num <- total_data %>%
  filter(tripduration > duration_mean) %>%
  count()
ride_num[1,1]

# Number of rides over average time with rain
rain_num <- total_data %>%
  filter(SNOW == 0, PRCP > 0, tripduration > duration_mean) %>%
  count()
rain_num[1,1]

# Number of rides over average time with snow
snow_num <- total_data %>%
  filter(SNOW > 0, tripduration > duration_mean) %>%
  count()
snow_num[1,1]

# Number of rides over average time with wind
wind_num <- total_data %>%
  filter(AWND > 0, tripduration > duration_mean) %>%
  count()
wind_num[1,1]
```

## Exploratory Data Analysis - Ride History

### Distance Between Stations

```{r}
# Distance between start and end station in Meters
total_data <- mutate(total_data, 
                            distance = distHaversine(cbind(total_data$start.station.longitude,
                                                           total_data$start.station.latitude),
                                                     cbind(total_data$end.station.longitude,
                                                           total_data$end.station.latitude)))

head(total_data)
```

### Speed of Rider Demographics

```{r}
# Speed of the rider
total_data$speed <- total_data$distance/total_data$tripduration

# Average speed of all riders
total_data %>%
  summarise(average_speed = mean(speed))

# Average speed of young riders
total_data %>%
  filter(age <= 45) %>%
  summarise(young_average = mean(speed))

# Average speed of old riders
total_data %>%
  filter(age >= 65) %>%
  summarise(old_average = mean(speed))

# Average speed of female riders
total_data %>%
  filter(gender == "Female") %>%
  summarise(female_average = mean(speed))

# Average speed of male riders
total_data %>%
  filter(gender == "Male") %>%
  summarise(male_average = mean(speed))

# Average speed of subscribers
total_data %>%
  filter(usertype == "Customer") %>%
  summarise(customer_average = mean(speed))

# Average speed of customers
total_data %>%
  filter(usertype == "Subscriber") %>%
  summarise(subscriber_average = mean(speed))
```

```{r}
# Scatter Plot of speed by age
total_data %>%
  ggplot(aes(x = age, y = speed, colour = gender)) +
  geom_point(alpha = .4, size = 1.5) +
  scale_colour_manual(name = 'Gender',
                      values = setNames(c('blue','magenta', 'dark green'),
                                        c('Male', 'Female', 'Unknown'))) +
  geom_smooth(method='lm', colour = 'black') +
  labs(title="Average Speed of Riders by Age", x="Speed", y="Age")
```

```{r}
# Boxplot of speed by gender
total_data %>%
  ggplot(aes(x = gender, y = speed, colour = gender)) +
  geom_boxplot(outlier.colour = 'red') +
  scale_colour_manual(name = 'Gender',
                      values = setNames(c('blue','magenta', 'dark green'),
                                        c('Male', 'Female', 'Unknown'))) +
  labs(title="Speed of Riders by Gender", x="Gender", y="Speed")
```

```{r}
# Boxplot of speed by customer type
total_data %>%
  ggplot(aes(x = usertype, y = speed, colour = usertype)) +
  geom_boxplot(outlier.colour = 'red') +
  scale_colour_manual(name = 'User Type',
                      values = setNames(c('purple', 'orange'),
                                        c('Subscriber', 'Customer'))) +
  labs(title="Speed of Riders by Customer Type", x="Customer Type", y="Speed")
```

